<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Photo Editor - Gemini</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® AI Photo Editor</h1>
            <p>Edit your photos with AI-powered Gemini</p>
        </header>

        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="message bot-message">
                    <div class="message-content">
                        <p>üëã Hello! I can help you edit images using AI.</p>
                        <p class="hint">Upload an image and describe how you'd like to edit it. For example: "Change background to beach sunset" or "Make it look like a painting"</p>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                
                <div class="input-wrapper">
                    <button class="attach-btn" id="attachBtn" title="Upload image">
                        üìé
                    </button>
                    <textarea 
                        id="promptInput" 
                        placeholder="Upload an image and describe how to edit it..."
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" disabled>
                        <span id="sendIcon">‚û§</span>
                        <span id="sendLoader" style="display: none;">‚è≥</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const attachBtn = document.getElementById('attachBtn');
        const promptInput = document.getElementById('promptInput');
        const sendBtn = document.getElementById('sendBtn');
        const sendIcon = document.getElementById('sendIcon');
        const sendLoader = document.getElementById('sendLoader');
        const messagesContainer = document.getElementById('messages');

        let currentImage = null;
        let lastEditedImageUrl = null;

        attachBtn.addEventListener('click', () => imageInput.click());

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                currentImage = file;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    addMessage('user', `üñºÔ∏è Uploaded image`, event.target.result);
                    
                    setTimeout(() => {
                        addMessage('bot', 'Great! Now tell me how you would like to edit this image.');
                    }, 500);
                    
                    promptInput.placeholder = "Describe your edit (e.g., 'make it black and white', 'add sunglasses')...";
                    promptInput.focus();
                    updateSendButton();
                };
                reader.readAsDataURL(file);
            }
        });

        promptInput.addEventListener('input', () => {
            promptInput.style.height = 'auto';
            promptInput.style.height = Math.min(promptInput.scrollHeight, 150) + 'px';
            updateSendButton();
        });

        function updateSendButton() {
            sendBtn.disabled = !(currentImage && promptInput.value.trim());
        }

        function addMessage(type, text, imageUrl = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (imageUrl) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-container';
                
                const img = document.createElement('img');
                img.src = imageUrl;
                img.className = 'chat-image';
                
                imgContainer.appendChild(img);
                contentDiv.appendChild(imgContainer);
            }
            
            if (text) {
                const p = document.createElement('p');
                p.innerHTML = text;
                contentDiv.appendChild(p);
            }
            
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        sendBtn.addEventListener('click', async () => {
            if (!currentImage || !promptInput.value.trim()) return;

            const prompt = promptInput.value.trim();
            
            addMessage('user', prompt);
            
            promptInput.value = '';
            promptInput.style.height = 'auto';
            sendIcon.style.display = 'none';
            sendLoader.style.display = 'inline';
            sendBtn.disabled = true;
            promptInput.disabled = true;

            const formData = new FormData();
            formData.append('image', currentImage);
            formData.append('prompt', prompt);

            try {
                addMessage('bot', '‚è≥ Processing your image... This may take 20-30 seconds.');

                const response = await fetch('/edit-image', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                messagesContainer.lastChild.remove();

                if (data.success) {
                    addMessage('bot', '‚ú® Here\'s your edited image:', data.image);
                    lastEditedImageUrl = data.image;
                    
                    try {
                        const imageResponse = await fetch(data.image);
                        const imageBlob = await imageResponse.blob();
                        currentImage = new File([imageBlob], 'edited_image.png', { type: 'image/png' });
                        
                        setTimeout(() => {
                            addMessage('bot', 'Want to edit it further? Just describe what you\'d like to change!');
                        }, 1000);
                    } catch (err) {
                        console.error('Error updating current image:', err);
                        setTimeout(() => {
                            addMessage('bot', 'Image edited successfully! Upload a new image to edit again.');
                        }, 1000);
                    }
                } else {
                    addMessage('bot', `‚ùå ${data.error}`);
                }
            } catch (error) {
                messagesContainer.lastChild.remove();
                addMessage('bot', `‚ùå Error: ${error.message}`);
            } finally {
                sendIcon.style.display = 'inline';
                sendLoader.style.display = 'none';
                sendBtn.disabled = false;
                promptInput.disabled = false;
                updateSendButton();
                promptInput.focus();
            }
        });

        promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendBtn.disabled) {
                    sendBtn.click();
                }
            }
        });

        updateSendButton();
    </script>
</body>
</html>
